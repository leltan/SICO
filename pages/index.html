<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SICO - Ocorrências</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background-color:#fff; }
    header { background-color:#fff; color:#333; padding:15px; text-align:center; position:relative; }
    header h1 { font-size:1.5rem; font-weight:bold; margin:0; }
    .header-line-green { height:6px; background-color:#00b42d; }
    .header-line-red { height:6px; background-color:#dc3545; }
    #btn-nova-ocorrencia {
      margin-top:10px; font-weight:bold; color:white; padding:10px 20px; border:none; cursor:pointer;
      border-radius:4px;
      background: repeating-linear-gradient(45deg,#000000ad,#000000 20px,#414141 20px,#2e2e2e 25px);
    }
    #btn-nova-ocorrencia:hover { opacity:0.9; }
    main { padding:20px; }
    table { width:100%; border-collapse:collapse; margin-bottom:20px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background-color:#333; color:white; }
    tr:nth-child(even) { background-color:#f2f2f2; }
    .card { background-color:#fff; border:1px solid #ddd; border-radius:5px; padding:20px; margin-bottom:20px; }
    .fixed-field { font-weight:bold; }
    footer { background-color:#333; color:#fff; text-align:center; padding:10px 0; }
    .empty-message { text-align:center; color:#777; font-style:italic; }
  </style>
</head>
<body>

  <!-- ====== HEADER ====== -->
  <header>
    <h1>SIACOM - Pirajuçara / Fervima</h1>
    <button id="btn-nova-ocorrencia" onclick="abrirSelecaoTipo()">Nova Ocorrência</button>
  </header>
  <div class="header-line-green"></div>
  <div class="header-line-red"></div>

  <!-- ====== MAIN ====== -->
  <main class="container my-4">

    <!-- Tabela -->
    <table class="table table-striped table-bordered">
      <thead class="thead-dark">
        <tr>
          <th>Protocolo</th>
          <th>Data</th>
          <th>Ocorrência</th>
          <th>Prefixo</th>
          <th>Situação</th>
          <th>Empresa</th>
        </tr>
      </thead>
      <tbody id="ocorrencias-list">
        <tr>
          <td colspan="6" class="empty-message">Nenhuma ocorrência encontrada.</td>
        </tr>
      </tbody>
    </table>

    <!-- Seleção tipo de ocorrência -->
    <div id="selecao-tipo" class="card" style="display:none;">
      <h2>Selecionar Tipo de Ocorrência</h2>
      <button class="btn btn-outline-primary mb-2" onclick="abrirFormulario('ATRASOS DE PARTIDA')">ATRASOS DE PARTIDA</button>
    </div>

    <!-- Formulário dinâmico -->
    <div id="formulario-ocorrencia" class="card" style="display:none;"></div>

  </main>

  <!-- ====== FOOTER ====== -->
  <footer>
    <p>&copy; 2025 VIAÇÃO FERVIMA / PIRAJUÇARA</p>
  </footer>

  <!-- ====== SCRIPT ====== -->
  <script>
    let contadorProtocolo = 1;

    // Abre seleção de tipo
    function abrirSelecaoTipo() {
      document.getElementById('selecao-tipo').style.display = 'block';
      document.getElementById('formulario-ocorrencia').style.display = 'none';
    }

    // Abre formulário de nova ocorrência
    function abrirFormulario(tipo) {
      const formDiv = document.getElementById('formulario-ocorrencia');
      formDiv.style.display = 'block';
      document.getElementById('selecao-tipo').style.display = 'none';
      formDiv.innerHTML = `
        <h2>${tipo}</h2>
        <form onsubmit="adicionarOcorrencia(event)">
          <div class="form-group">
            <label>Empresa:</label>
            <select class="form-control" id="empresa" required>
              <option value="FERVIMA">FERVIMA</option>
              <option value="PIRAJUCARA">PIRAJUCARA</option>
            </select>
          </div>
          <div class="form-group">
            <label>Data de Início:</label>
            <input type="date" class="form-control" id="data_inicio">
          </div>
          <div class="form-group">
            <label>Hora de Início:</label>
            <input type="time" class="form-control" id="hora_inicio">
          </div>
          <div class="form-group">
            <label>Locais:</label>
            <input type="text" class="form-control" id="locais" placeholder="Digite os locais">
          </div>
          <button type="submit" class="btn btn-success">Adicionar</button>
          <button type="button" class="btn btn-secondary ml-2" onclick="abrirSelecaoTipo()">Cancelar</button>
        </form>
      `;
    }

    // Carrega tabela com backend
    async function carregarTabela() {
      const res = await fetch('http://localhost:3000/ocorrencias', { credentials: 'include' });
      const ocorrencias = await res.json();
      const tabela = document.getElementById('ocorrencias-list');
      tabela.innerHTML = '';

      if (ocorrencias.length === 0) {
        tabela.innerHTML = `<tr><td colspan="6" class="empty-message">Nenhuma ocorrência encontrada.</td></tr>`;
        return;
      }

      ocorrencias.forEach(o => {
        const linha = tabela.insertRow();
        const cellProtocolo = linha.insertCell(0);
        const btn = document.createElement('button');
        btn.textContent = o.protocolo;
        btn.className = 'btn btn-link p-0';
        btn.onclick = () => abrirEdicao(o.protocolo);
        cellProtocolo.appendChild(btn);

        linha.insertCell(1).textContent = o.data_inicio + ' ' + (o.hora_inicio || '');
        linha.insertCell(2).textContent = o.ocorrencia;
        linha.insertCell(3).textContent = o.prefixo || '';
        linha.insertCell(4).textContent = o.situacao || '';
        linha.insertCell(5).textContent = o.empresa;
      });
    }

    // Adicionar ocorrência
    async function adicionarOcorrencia(event) {
      event.preventDefault();
      const dados = {
        protocolo: String(contadorProtocolo).padStart(5,'0') + '/' + new Date().getFullYear(),
        empresa: document.getElementById('empresa').value,
        data_inicio: document.getElementById('data_inicio').value,
        hora_inicio: document.getElementById('hora_inicio').value,
        locais: document.getElementById('locais').value,
        ocorrencia: 'ATRASOS DE PARTIDA'
      };
      await fetch('http://localhost:3000/ocorrencias', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(dados)
      });
      contadorProtocolo++;
      document.getElementById('formulario-ocorrencia').style.display = 'none';
      abrirSelecaoTipo();
      carregarTabela();
    }

    // Abrir edição de ocorrência
    async function abrirEdicao(protocolo) {
      const res = await fetch(`http://localhost:3000/ocorrencias/${protocolo}`);
      const o = await res.json();
      const formDiv = document.getElementById('formulario-ocorrencia');
      formDiv.style.display = 'block';
      document.getElementById('selecao-tipo').style.display = 'none';
      formDiv.innerHTML = `
        <h2>Editar Ocorrência</h2>
        <form onsubmit="salvarEdicao(event, ${o.id})">
          <div class="form-group">
            <label>Empresa:</label>
            <input type="text" class="form-control" id="empresa_edit" value="${o.empresa}">
          </div>
          <div class="form-group">
            <label>Data de Início:</label>
            <input type="date" class="form-control" id="data_inicio_edit" value="${o.data_inicio}">
          </div>
          <div class="form-group">
            <label>Hora de Início:</label>
            <input type="time" class="form-control" id="hora_inicio_edit" value="${o.hora_inicio}">
          </div>
          <div class="form-group">
            <label>Locais:</label>
            <input type="text" class="form-control" id="locais_edit" value="${o.locais}">
          </div>
          <div style="margin-top:15px;">
            <button type="submit" class="btn btn-success">Salvar</button>
            <button type="button" class="btn btn-secondary ml-2" onclick="abrirSelecaoTipo()">Cancelar</button>
          </div>
        </form>
      `;
    }

    // Salvar edição
    async function salvarEdicao(event, id) {
      event.preventDefault();
      const dados = {
        empresa: document.getElementById('empresa_edit').value,
        data_inicio: document.getElementById('data_inicio_edit').value,
        hora_inicio: document.getElementById('hora_inicio_edit').value,
        locais: document.getElementById('locais_edit').value,
        ocorrencia: 'ATRASOS DE PARTIDA'
      };
      await fetch(`http://localhost:3000/ocorrencias/${id}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(dados)
      });
      document.getElementById('formulario-ocorrencia').style.display='none';
      carregarTabela();
    }

    window.onload = carregarTabela;
  </script>
</body>
</html>
